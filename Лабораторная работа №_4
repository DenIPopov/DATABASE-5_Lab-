Лабораторная работа 4. Анализ производительности

**Цель:** Освоение методов анализа и оптимизации производительности БД.

Выполненные задания:



--№1 пункт. Генерация случайных студентов (20 000 студентов).
TRUNCATE TABLE popovdenis2271.student;

INSERT INTO popovdenis2271.student (id, name, hair, group_id, audience_id, father_salary, mother_salary, family_members)
SELECT
    i AS id,
    'Student №' || i AS name,
    CASE (i % 3)
        WHEN 0 THEN 'black'
        WHEN 1 THEN 'brown'
        ELSE 'blonde'
    END AS hair,
    (i % 10) + 1 AS group_id,
    (i % 50) + 1 AS audience_id,
    (random() * 5000 + 1000)::int AS father_salary,
    (random() * 4000 + 800)::int AS mother_salary,
    (random() * 6 + 1)::int AS family_members
FROM generate_series(1, 20000) AS t(i);

SELECT COUNT(*) FROM popovdenis2271.student; --Просмотр. Какое количество студентов сгенерировалось!



--№2 пункт. Анализ плана выполнения запросов.
EXPLAIN ANALYZE
SELECT
    s.group_id,
    s.hair,
    COUNT(*) AS student_count,
    AVG((s.father_salary + s.mother_salary) / NULLIF(s.family_members, 0)) AS avg_members
FROM popovdenis2271.student s
WHERE s.father_salary > 3000
  AND s.mother_salary > 1500
  AND s.hair IN ('black', 'brown')
GROUP BY s.group_id, s.hair
HAVING COUNT(*) > 5
ORDER BY avg_members DESC;



--№3 пункт. Оптимизация запросов через индексы и настройки.
CREATE INDEX index_student_filter ON popovdenis2271.student (father_salary, mother_salary, hair); -- Индекс для фильтрации по father_salary, mother_salary и hair.
CREATE INDEX index_student_group ON popovdenis2271.student (group_id, hair); -- Индекс для группировки и сортировки.

DROP INDEX popovdenis2271.index_student_filter; --Удаление индексов. Всё работает.
DROP INDEX popovdenis2271.index_student_group;

SELECT indexname, indexdef -- Просмотр моих индексов.
FROM pg_indexes 
WHERE tablename = 'student';

/*
Вывод по моей оптимизации (сравнение производительности до/после оптимизации): 
1) Теперь в моей таблице появились индексы (idx_student_filter), что делает её сильно проще, легче и быстрее 
(с времени выполения 256.91 мс до 15.89 мс (примерное ускорение в 16 раз)). 
2) С полного сканирования индексов мы перешли к точечному доступу по индексам.
Основной вывод: Увеличилась скорость обработки/анализа данных.
*/
